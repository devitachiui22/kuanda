<!DOCTYPE html>
<html lang="pt-AO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* =========================================
           KUANDA CATEGORY HUB - 3D FLUENCY EDITION
           ========================================= */
        :root {
            --k-red: #E31C25;
            --k-black: #0F0F0F;
            --k-gray: #F3F4F6;
            --card-radius: 24px;
        }

        /* 1. HERO BANNER */
        .cat-hero-wrapper {
            margin-bottom: 50px;
            position: relative;
        }
        .carousel-rounded {
            border-radius: 24px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            transform: translateZ(0);
        }
        .carousel-item img { height: 350px; object-fit: cover; filter: brightness(0.8); }
        
        .hero-overlay {
            position: absolute; inset: 0; 
            background: linear-gradient(to right, rgba(0,0,0,0.9), transparent);
            display: flex; align-items: center; padding: 60px; pointer-events: none;
        }
        .hero-text { color: white; max-width: 600px; }
        .hero-text h1 { font-size: 3.5rem; font-weight: 800; margin-bottom: 10px; line-height: 1.1; letter-spacing: -1px; }
        .hero-text p { color: rgba(255,255,255,0.9); font-size: 1.2rem; font-weight: 500; }

        /* 2. GRID DE CATEGORIAS (PREMIUM 3D) */
        .categories-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding: 0 10px;
        }
        .cat-section-title { font-size: 1.8rem; font-weight: 800; color: var(--k-black); }

        .categories-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 25px; margin-bottom: 80px;
        }

        .cat-card-premium {
            background: white; border-radius: var(--card-radius);
            padding: 30px 15px; text-align: center;
            border: 1px solid rgba(0,0,0,0.04); box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-decoration: none; display: flex; flex-direction: column; align-items: center;
            position: relative; overflow: hidden; cursor: pointer;
        }
        
        .cat-card-premium:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px rgba(227, 28, 37, 0.1);
            border-color: rgba(227, 28, 37, 0.1);
        }

        /* Container do Ícone 3D */
        .cat-icon-box {
            width: 90px; height: 90px; border-radius: 30px; /* Squircle */
            background: #F8F9FA; 
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px;
            transition: 0.4s ease;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
        }
        
        /* Imagem 3D */
        .cat-img-3d {
            width: 60px; height: 60px; object-fit: contain;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 8px 15px rgba(0,0,0,0.15));
        }

        .cat-card-premium:hover .cat-icon-box {
            background: #fff;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        
        .cat-card-premium:hover .cat-img-3d {
            transform: scale(1.25) rotate(-10deg) translateY(-5px);
        }

        .cat-title { 
            font-weight: 800; font-size: 1.1rem; color: #4B5563; 
            margin-bottom: 5px; transition: 0.3s; 
        }
        .cat-card-premium:hover .cat-title { color: var(--k-black); }
        
        .cat-count { 
            font-size: 0.8rem; color: #E31C25; font-weight: 700; opacity: 0; transform: translateY(10px); transition: 0.3s; 
        }
        .cat-card-premium:hover .cat-count { opacity: 1; transform: translateY(0); }

        /* 3. SEÇÃO DE PRODUTOS (DESTAQUES) */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;
        }
        .sec-title { font-size: 1.5rem; font-weight: 800; color: var(--k-black); margin: 0; display: flex; align-items: center; gap: 10px; }
        
        /* Grid Produtos */
        .products-showcase {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 80px;
        }
        
        /* Miniatura Produto */
        .prod-mini {
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s;
            border: 1px solid rgba(0,0,0,0.03); position: relative;
        }
        .prod-mini:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        
        .prod-mini-img-box { position: relative; height: 220px; background: #f8f9fa; overflow: hidden; }
        .prod-mini-img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .prod-mini:hover .prod-mini-img { transform: scale(1.08); }
        
        .prod-mini-body { padding: 20px; }
        .prod-mini-title { font-size: 1rem; font-weight: 700; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--k-black); text-decoration: none; display: block; }
        .prod-mini-price { font-weight: 800; color: var(--k-red); font-size: 1.1rem; }

        .btn-add-mini {
            position: absolute; bottom: 15px; right: 15px;
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--k-black); color: white; border: none;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.2s; cursor: pointer;
        }
        .btn-add-mini:hover { background: var(--k-red); transform: scale(1.1); }

        /* 4. SEÇÃO LOJAS (SLIDER) */
        .stores-slider {
            display: flex; gap: 20px; overflow-x: auto; padding: 10px 5px 30px;
            scrollbar-width: none;
        }
        .store-pill {
            min-width: 280px; background: white; padding: 20px; border-radius: 20px;
            display: flex; align-items: center; gap: 15px;
            border: 1px solid rgba(0,0,0,0.05); transition: 0.3s; text-decoration: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }
        .store-pill:hover { border-color: var(--k-black); transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        
        .store-pill-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; }
        .store-pill-placeholder { width: 60px; height: 60px; border-radius: 50%; background: var(--k-black); color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.5rem; }
        
        .store-pill-info h6 { margin: 0 0 5px; font-weight: 800; color: var(--k-black); font-size: 1.1rem; }
        .store-pill-info span { font-size: 0.85rem; color: #888; font-weight: 500; }

        /* Responsivo */
        @media (max-width: 768px) {
            .hero-text h1 { font-size: 2rem; }
            .carousel-item img { height: 220px; }
            .hero-overlay { padding: 30px 20px; justify-content: center; text-align: center; }
            
            .categories-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; } /* 2 colunas no mobile */
            .cat-card-premium { padding: 20px 10px; }
            .cat-icon-box { width: 70px; height: 70px; margin-bottom: 15px; }
            .cat-img-3d { width: 45px; height: 45px; }
            .cat-title { font-size: 0.9rem; }
            
            .products-showcase {
                grid-template-columns: repeat(3, 1fr); /* 3 colunas mobile (pedido do usuário) */
                gap: 8px;
            }
            .prod-mini-img-box { height: 120px; }
            .prod-mini-body { padding: 10px; }
            .prod-mini-title { font-size: 0.7rem; margin-bottom: 2px; }
            .prod-mini-price { font-size: 0.8rem; }
            .btn-add-mini { width: 28px; height: 28px; font-size: 0.7rem; bottom: 8px; right: 8px; }
        }
    </style>
</head>
<body>

<div class="container py-4">

    <!-- 1. HERO BANNER (DINÂMICO) -->
    <section class="cat-hero-wrapper fade-up">
        <div id="catCarousel" class="carousel slide carousel-fade carousel-rounded" data-bs-ride="carousel">
            <div class="carousel-inner">
                <% if (typeof banners !== 'undefined' && banners.length > 0) { %>
                    <% banners.forEach((banner, index) => { %>
                        <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                            <img src="<%= banner.imagem %>" class="d-block w-100" alt="Banner">
                            <div class="hero-overlay">
                                <div class="hero-text">
                                    <h1>Departamentos</h1>
                                    <p>Explore nossa variedade de produtos organizados para você.</p>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div class="carousel-item active">
                        <div class="d-block w-100 bg-dark" style="height: 350px;"></div>
                        <div class="hero-overlay">
                            <div class="hero-text">
                                <h1>Departamentos</h1>
                                <p>Encontre tudo o que precisa em um só lugar.</p>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </section>

    <!-- 2. GRID DE CATEGORIAS (ICONS8 3D FLUENCY) -->
    <div class="categories-header fade-up" style="animation-delay: 0.1s;">
        <h2 class="cat-section-title">Navegar por Categoria</h2>
        <span class="text-muted small fw-bold"><%= typeof categorias !== 'undefined' ? categorias.length : 0 %> departamentos</span>
    </div>

    <section class="categories-grid fade-up" style="animation-delay: 0.2s;">
        <% 
        // URL Base da Biblioteca 3D Fluency (Icons8)
        const baseIconUrl = "https://img.icons8.com/3d-fluency/94/";
        
        // Mapeamento Completo e Bonito
        const catMap = {
            'dress': 'car.png',
            'celulares': 'iphone.png',
            'tecnologia': 'workstation.png',
            'informática': 'laptop.png',
            'computadores': 'workstation.png',
            'car': 't.png',
            'roupas': 't-shirt.png',
            'casa': 'home.png',
            'car': 'sofa.png',
            'beleza': 'lipstick.png',
            'saúde': 'heart-with-pulse.png',
            'jogos': 'game-controller.png',
            'games': 'game-controller.png',
            'auto': 'car.png',
            'carros': 'car.png',
            'livros': 'books.png',
            'educação': 'graduation-cap.png',
            'sapatos': 'sneakers.png',
            'tênis': 'sneakers.png',
            'esportes': 'basketball.png',
            'fitness': 'dumbbell.png',
            'música': 'musical-notes.png',
            'instrumentos': 'guitar.png',
            'infantil': 'teddy-bear.png',
            'brinquedos': 'rubiks-cube.png',
            'ferramentas': 'hammer.png',
            'jardim': 'potted-plant.png',
            'relógios': 'watch.png',
            'acessórios': 'diamond.png'
        };
        
        // Ícone Padrão (Caixa de presente)
        const defaultIcon = 'gift.png'; 

        if (typeof categorias !== 'undefined') { 
            categorias.forEach((cat, index) => { 
                let iconName = defaultIcon;
                
                // Busca Inteligente (Case Insensitive)
                for (const [key, value] of Object.entries(catMap)) {
                    if (cat.nome.toLowerCase().includes(key.toLowerCase())) {
                        iconName = value;
                        break;
                    }
                }
        %>
            <a href="/produtos?categoria=<%= cat.id %>" class="cat-card-premium fade-up" style="animation-delay: <%= index * 0.05 %>s;">
                <div class="cat-icon-box">
                    <!-- ÍCONE 3D AQUI -->
                    <img src="<%= baseIconUrl + iconName %>" 
                         alt="<%= cat.nome %>" 
                         class="cat-img-3d"
                         loading="lazy">
                </div>
                <span class="cat-title"><%= cat.nome %></span>
                <span class="cat-count">Ver Produtos <i class="fas fa-arrow-right ms-1 small"></i></span>
            </a>
        <% }); } %>
    </section>

    <!-- 3. PRODUTOS EM DESTAQUE (VITRINE) -->
    <% if (typeof produtosDestaque !== 'undefined' && produtosDestaque.length > 0) { %>
        <section class="mb-5 fade-up" style="animation-delay: 0.3s;">
            <div class="section-header">
                <h3 class="sec-title"><i class="fas fa-star text-warning"></i> Destaques da Semana</h3>
                <a href="/produtos" class="btn btn-outline-dark rounded-pill px-4 fw-bold">Ver Todos</a>
            </div>

            <div class="products-showcase">
                <% produtosDestaque.forEach(prod => { %>
                    <div class="prod-mini">
                        <a href="/produto/<%= prod.id %>" class="prod-mini-img-box d-block">
                            <% if (prod.imagem1) { %>
                                <img src="/uploads/produtos/<%= prod.imagem1 %>" class="prod-mini-img" loading="lazy">
                            <% } else { %>
                                <div class="prod-mini-img d-flex align-items-center justify-content-center text-muted"><i class="fas fa-image fa-2x"></i></div>
                            <% } %>
                            
                            <!-- Botão Flutuante -->
                            <button class="btn-add-mini" onclick="event.preventDefault(); addToCart(<%= prod.id %>, '<%= prod.nome.replace(/'/g, "\\'") %>')">
                                <i class="fas fa-plus"></i>
                            </button>
                        </a>
                        
                        <div class="prod-mini-body">
                            <a href="/produto/<%= prod.id %>" class="prod-mini-title"><%= prod.nome %></a>
                            <div class="prod-mini-price"><%= Number(prod.preco).toLocaleString('pt-AO') %> Kz</div>
                        </div>
                    </div>
                <% }) %>
            </div>
        </section>
    <% } %>

    <!-- 4. LOJAS PARCEIRAS (SLIDER) -->
    <% if (typeof lojas !== 'undefined' && lojas.length > 0) { %>
        <section class="mb-5 fade-up" style="animation-delay: 0.4s;">
            <div class="section-header">
                <h3 class="sec-title"><i class="fas fa-store text-primary"></i> Lojas Oficiais</h3>
                <a href="/lojas" class="btn btn-outline-dark rounded-pill px-4 fw-bold">Ver Todas</a>
            </div>

            <div class="stores-slider">
                <% lojas.forEach(loja => { %>
                    <a href="/loja/<%= loja.id %>" class="store-pill">
                        <% if (loja.foto_perfil) { %>
                            <img src="/uploads/perfil/<%= loja.foto_perfil %>" class="store-pill-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=<%= loja.nome_loja.charAt(0) %>&background=0F0F0F&color=fff';">
                        <% } else { %>
                            <div class="store-pill-placeholder">
                                <%= loja.nome_loja.charAt(0).toUpperCase() %>
                            </div>
                        <% } %>
                        <div class="store-pill-info">
                            <h6><%= loja.nome_loja %></h6>
                            <span><%= loja.total_produtos || 0 %> produtos • <%= parseFloat(loja.media_classificacao || 0).toFixed(1) %> <i class="fas fa-star text-warning"></i></span>
                        </div>
                        <i class="fas fa-chevron-right ms-auto text-muted"></i>
                    </a>
                <% }) %>
            </div>
        </section>
    <% } %>

</div>

<script>
    // Animação de Entrada
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animationPlayState = 'running';
                observer.unobserve(entry.target);
            }
        });
    });
    
    document.querySelectorAll('.fade-up').forEach(el => {
        el.style.animationPlayState = 'paused';
        observer.observe(el);
    });

    // Função Adicionar ao Carrinho (Com Feedback)
    function addToCart(id, nome) {
        const btn = event.target.closest('button');
        const originalIcon = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        fetch('/carrinho/adicionar', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `produto_id=${id}&quantidade=1`
        })
        .then(r => r.json())
        .then(d => {
            if(d.success) {
                btn.style.background = '#10B981';
                btn.innerHTML = '<i class="fas fa-check"></i>';
                if(window.CartManager) window.CartManager.updateCount();
                
                setTimeout(() => {
                    btn.style.background = ''; 
                    btn.innerHTML = originalIcon;
                }, 1500);
            } else {
                alert(d.message);
                btn.innerHTML = originalIcon;
            }
        })
        .catch(e => {
            console.error(e);
            btn.innerHTML = originalIcon;
        });
    }
</script>

</body>
</html>