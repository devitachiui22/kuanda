<div class="container py-4">
  <h2 class="mb-4">
    <i class="fas fa-check-circle me-2"></i>Finalizar Compra
  </h2>

  <div class="row">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0">Como funciona?</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 text-center mb-3">
              <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center text-white mb-2" 
                   style="width: 60px; height: 60px;">
                <i class="fab fa-whatsapp fa-2x"></i>
              </div>
              <h6>1. WhatsApp</h6>
              <p class="small text-muted">Voc√™ ser√° redirecionado para o WhatsApp do vendedor</p>
            </div>
            <div class="col-md-4 text-center mb-3">
              <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center text-white mb-2" 
                   style="width: 60px; height: 60px;">
                <i class="fas fa-comments fa-2x"></i>
              </div>
              <h6>2. Negocia√ß√£o</h6>
              <p class="small text-muted">Converse diretamente com o vendedor sobre os produtos</p>
            </div>
            <div class="col-md-4 text-center mb-3">
              <div class="bg-warning rounded-circle d-inline-flex align-items-center justify-content-center text-white mb-2" 
                   style="width: 60px; height: 60px;">
                <i class="fas fa-handshake fa-2x"></i>
              </div>
              <h6>3. Finaliza√ß√£o</h6>
              <p class="small text-muted">Acerte os detalhes da compra e pagamento</p>
            </div>
          </div>
        </div>
      </div>

      <% Object.values(produtosPorVendedor).forEach(vendedorData => { %>
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header">
            <div class="d-flex align-items-center">
              <i class="fas fa-store me-2"></i>
              <h5 class="mb-0"><%= vendedorData.vendedor %></h5>
            </div>
          </div>
          <div class="card-body">
            <% vendedorData.produtos.forEach(produto => { %>
              <div class="row align-items-center mb-3 pb-3 border-bottom">
                <div class="col-md-2">
                  <img src="/uploads/<%= produto.imagem %>" alt="<%= produto.nome %>" 
                       class="img-fluid rounded" style="height: 60px; object-fit: cover;">
                </div>
                <div class="col-md-5">
                  <h6 class="mb-1"><%= produto.nome %></h6>
                  <p class="text-muted small mb-0">Quantidade: <%= produto.quantidade %></p>
                </div>
                <div class="col-md-2">
                  <span class="fw-bold"><%= produto.preco %> Kz</span>
                </div>
                <div class="col-md-3 text-end">
                  <span class="fw-bold text-primary">
                    <%= (produto.preco * produto.quantidade).toFixed(2) %> Kz
                  </span>
                </div>
              </div>
            <% }) %>
            
            <div class="row">
              <div class="col-md-8">
                <strong>Total desta loja:</strong>
              </div>
              <div class="col-md-4 text-end">
                <strong class="text-success fs-5"><%= vendedorData.total.toFixed(2) %> Kz</strong>
              </div>
            </div>
            
            <div class="mt-3">
              <a href="<%= generateWhatsAppLink(vendedorData) %>" 
                 target="_blank" class="btn btn-success btn-lg w-100">
                <i class="fab fa-whatsapp me-2"></i>
                Conversar com <%= vendedorData.vendedor %> no WhatsApp
              </a>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <div class="col-lg-4">
      <div class="card border-0 shadow-sm sticky-top">
        <div class="card-header">
          <h5 class="mb-0">Resumo Final</h5>
        </div>
        <div class="card-body">
          <% 
          let totalGeral = 0;
          let totalItens = 0;
          Object.values(produtosPorVendedor).forEach(vendedorData => {
            totalGeral += vendedorData.total;
            totalItens += vendedorData.produtos.reduce((sum, p) => sum + p.quantidade, 0);
          });
          %>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Total de itens:</span>
            <span><%= totalItens %></span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Vendedores:</span>
            <span><%= Object.keys(produtosPorVendedor).length %></span>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-3">
            <strong>Total Geral:</strong>
            <strong class="text-success fs-4"><%= totalGeral.toFixed(2) %> Kz</strong>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <small>
              Voc√™ ser√° redirecionado para o WhatsApp de cada vendedor separadamente.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%
function generateWhatsAppLink(vendedorData) {
  let message = `Ol√°! Vim do KuandaShop e gostaria de comprar os seguintes produtos:\n\n`;
  
  vendedorData.produtos.forEach(produto => {
    message += `üì¶ *${produto.nome}*\n`;
    message += `   Quantidade: ${produto.quantidade}\n`;
    message += `   Pre√ßo unit√°rio: ${produto.preco} Kz\n`;
    message += `   Subtotal: ${(produto.preco * produto.quantidade).toFixed(2)} Kz\n\n`;
  });
  
  message += `üí∞ *Total: ${vendedorData.total.toFixed(2)} Kz*\n\n`;
  message += `Podemos conversar sobre os detalhes da compra?`;
  
  const phone = vendedorData.telefone.replace(/\D/g, '');
  return `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
}
%>

<script>
  // Clear cart after successful redirect
  document.addEventListener('DOMContentLoaded', function() {
    // Clear cart from session storage
    sessionStorage.removeItem('cart');
    
    // Update cart count
    document.getElementById('cartCount').textContent = '0';
    
    // Add click tracking for WhatsApp links
    document.querySelectorAll('a[href*="wa.me"]').forEach(link => {
      link.addEventListener('click', function() {
        // Track successful checkout
        console.log('Checkout completed via WhatsApp');
        
        // Optional: Send analytics event
        // gtag('event', 'purchase', { ... });
      });
    });
  });
</script>
