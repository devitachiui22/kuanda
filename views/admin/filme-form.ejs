<!DOCTYPE html>
<html lang="pt-AO">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* =========================================
       KUANDA LIGHT STUDIO (CLEAN & DEPTH)
       ========================================= */
    :root {
      --k-red: #E31C25;
      --k-black: #111827;
      --k-gray-soft: #F9FAFB;
      --k-gray-border: #E5E7EB;
      --radius-xl: 24px;
      --radius-lg: 16px;
      --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --shadow-float: 0 20px 40px -5px rgba(0, 0, 0, 0.08);
      --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.02);
    }

    body { background-color: #F3F4F6; color: var(--k-black); }

    /* Container Principal - Papel Branco Flutuante */
    .editor-card {
      background: #FFFFFF;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-float);
      margin-top: 30px;
      overflow: hidden;
      border: 1px solid white;
    }

    /* Header Limpo */
    .editor-header {
      padding: 30px 40px;
      border-bottom: 1px solid var(--k-gray-border);
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
    }
    
    .page-title {
      font-weight: 800; font-size: 1.5rem; margin: 0;
      color: var(--k-black); display: flex; align-items: center; gap: 12px;
    }
    .icon-box {
      width: 40px; height: 40px; border-radius: 12px; background: #FFF1F2;
      color: var(--k-red); display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
    }

    .btn-back {
      color: #6B7280; font-weight: 600; text-decoration: none;
      padding: 10px 20px; border-radius: 30px; background: #F3F4F6;
      transition: 0.2s; font-size: 0.9rem;
    }
    .btn-back:hover { background: #E5E7EB; color: var(--k-black); }

    /* Layout do Formulário */
    .editor-body {
      display: grid; grid-template-columns: 1.2fr 0.8fr;
    }
    
    .form-section { padding: 40px; }
    .preview-section {
      background: #FAFAFA; border-left: 1px solid var(--k-gray-border);
      padding: 40px; display: flex; flex-direction: column; align-items: center;
    }

    /* Inputs Modernos (Com Profundidade) */
    .form-group { margin-bottom: 25px; }
    
    .input-label {
      font-size: 0.75rem; font-weight: 700; color: #6B7280;
      text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;
    }
    
    .custom-input {
      width: 100%; padding: 14px 18px; border-radius: var(--radius-lg);
      background: #FFFFFF; border: 1px solid var(--k-gray-border);
      color: var(--k-black); font-weight: 600; outline: none;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-soft);
    }
    .custom-input:focus {
      border-color: var(--k-red); box-shadow: 0 0 0 4px rgba(227, 28, 37, 0.05);
      transform: translateY(-1px);
    }
    .custom-input::placeholder { color: #9CA3AF; font-weight: 400; }
    
    .textarea-custom { resize: vertical; min-height: 120px; line-height: 1.6; }

    /* Upload Zone (Clean) */
    .poster-upload {
      width: 100%; height: 280px;
      background: #FFFFFF; border: 2px dashed #E5E7EB; border-radius: var(--radius-lg);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.3s; position: relative; overflow: hidden;
    }
    .poster-upload:hover { border-color: var(--k-red); background: #FFF5F5; }
    
    .upload-content { text-align: center; pointer-events: none; }
    .upload-icon { font-size: 3rem; color: #E5E7EB; margin-bottom: 15px; transition: 0.3s; }
    .poster-upload:hover .upload-icon { color: var(--k-red); transform: scale(1.1); }
    .upload-hint { font-size: 0.85rem; color: #6B7280; font-weight: 500; }

    /* Imagem Preview no Upload */
    .upload-preview-img {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      object-fit: contain; z-index: 2; background: white;
    }
    .upload-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 3;
      display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.2s;
    }
    .poster-upload:hover .upload-overlay { opacity: 1; }
    .btn-change {
      background: white; color: black; padding: 8px 16px; border-radius: 20px;
      font-weight: 700; font-size: 0.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    /* Classificação Etária (Botões Coloridos) */
    .rating-wrapper {
      display: flex; gap: 10px; background: #FFFFFF; padding: 10px;
      border-radius: 16px; border: 1px solid var(--k-gray-border); width: fit-content;
    }
    .rating-option { display: none; }
    .rating-tile {
      width: 36px; height: 36px; border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 0.85rem; transition: 0.2s;
      color: #9CA3AF; background: #F3F4F6;
    }
    
    /* Cores Ativas */
    .rating-option:checked + .rating-tile { transform: scale(1.15); box-shadow: 0 4px 10px rgba(0,0,0,0.15); color: white; }
    .rating-option[value="L"]:checked + .rating-tile { background: #00B050; }
    .rating-option[value="10"]:checked + .rating-tile { background: #0066FF; }
    .rating-option[value="12"]:checked + .rating-tile { background: #FFC107; color: black; }
    .rating-option[value="14"]:checked + .rating-tile { background: #FF6600; }
    .rating-option[value="16"]:checked + .rating-tile { background: #FF0000; }
    .rating-option[value="18"]:checked + .rating-tile { background: #000000; }

    /* Switch Status (iOS Style) */
    .switch-container {
      display: flex; align-items: center; justify-content: space-between;
      background: #FFFFFF; padding: 15px 20px; border-radius: var(--radius-lg);
      border: 1px solid var(--k-gray-border); box-shadow: var(--shadow-soft);
    }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E5E7EB; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input:checked + .slider { background-color: var(--k-red); }
    input:checked + .slider:before { transform: translateX(22px); }

    /* CARD PREVIEW REALISTA (Estilo Apple/Moderno) */
    .preview-header {
      font-size: 0.75rem; font-weight: 800; color: #9CA3AF; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 20px;
    }
    
    .movie-card-clean {
      width: 260px; background: white; border-radius: 20px; overflow: hidden;
      box-shadow: 0 30px 60px -10px rgba(0,0,0,0.15); /* Sombra Profunda */
      position: relative; transition: 0.3s;
    }
    
    .mc-poster {
      width: 100%; aspect-ratio: 2/3; background: #E5E7EB; position: relative;
    }
    .mc-poster img { width: 100%; height: 100%; object-fit: cover; }
    
    /* Overlay Gradiente Branco */
    .mc-info {
      padding: 20px; position: relative;
    }
    
    .mc-title {
      font-size: 1.2rem; font-weight: 800; color: var(--k-black);
      margin-bottom: 5px; line-height: 1.2;
    }
    
    .mc-meta {
      display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #6B7280; font-weight: 600;
    }
    
    .mc-rating {
      padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 0.7rem; color: white; background: #9CA3AF;
    }

    .mc-action {
      margin-top: 15px; width: 100%; padding: 10px; border-radius: 12px;
      background: #F3F4F6; color: var(--k-black); font-weight: 700; border: none; font-size: 0.85rem;
    }

    /* Botão Principal Salvar */
    .btn-save {
      width: 100%; background: var(--k-red); color: white; border: none;
      padding: 16px; border-radius: 50px; font-weight: 700; font-size: 1rem;
      margin-top: 30px; cursor: pointer; transition: 0.3s;
      box-shadow: 0 10px 25px rgba(227, 28, 37, 0.25);
    }
    .btn-save:hover { background: #b01018; transform: translateY(-3px); box-shadow: 0 15px 35px rgba(227, 28, 37, 0.35); }

    /* Responsivo */
    @media (max-width: 991px) {
      .editor-body { grid-template-columns: 1fr; }
      .form-section { border-right: none; border-bottom: 1px solid #eee; }
      .preview-section { order: -1; padding: 40px 20px; }
    }
  </style>
</head>
<body>

<div class="container pb-5">
  
  <div class="editor-card">
    
    <!-- HEADER -->
    <div class="editor-header">
      <h2 class="page-title">
        <div class="icon-box"><i class="fas fa-clapperboard"></i></div>
        <%= filme ? 'Editar Filme' : 'Novo Filme' %>
      </h2>
      <a href="/admin/filmes" class="btn-back"><i class="fas fa-arrow-left me-2"></i>Voltar</a>
    </div>

    <!-- FORMULÁRIO -->
    <!-- ROTA CORRIGIDA: Usa POST com _method=PUT para update -->
    <form action="<%= filme ? '/admin/filmes/' + filme.id + '?_method=PUT' : '/admin/filmes' %>" 
          method="POST" 
          enctype="multipart/form-data" 
          class="editor-body">
      
      <!-- COLUNA ESQUERDA: FORMULÁRIO -->
      <div class="form-section">
        
        <div class="row g-4">
            
            <!-- Título -->
            <div class="col-12">
                <div class="form-group mb-0">
                    <label class="input-label">Título do Filme</label>
                    <input type="text" class="custom-input" id="titulo" name="titulo" 
                           value="<%= filme ? filme.titulo : '' %>" 
                           placeholder="Ex: Gladiador II" required oninput="updatePreview()">
                </div>
            </div>

            <!-- Trailer e Data -->
            <div class="col-md-7">
                <div class="form-group mb-0">
                    <label class="input-label">Link do Trailer (YouTube)</label>
                    <input type="url" class="custom-input" name="trailer_url" 
                           value="<%= filme ? filme.trailer_url : '' %>" 
                           placeholder="https://...">
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-group mb-0">
                    <label class="input-label">Data Lançamento</label>
                    <input type="date" class="custom-input" id="data" name="data_lancamento" 
                           value="<%= filme && filme.data_lancamento ? new Date(filme.data_lancamento).toISOString().split('T')[0] : '' %>" 
                           onchange="updatePreview()">
                </div>
            </div>

            <!-- Classificação -->
            <div class="col-12">
                <div class="form-group mb-0">
                    <label class="input-label">Classificação Indicativa</label>
                    <div class="rating-wrapper">
                        <% ['L', '10', '12', '14', '16', '18'].forEach(rate => { %>
                            <label>
                                <input type="radio" name="classificacao" value="<%= rate %>" class="rating-option" 
                                       <%= (filme && filme.classificacao == rate) ? 'checked' : '' %> onchange="updatePreview()">
                                <div class="rating-tile"><%= rate %></div>
                            </label>
                        <% }) %>
                    </div>
                </div>
            </div>

            <!-- Sinopse -->
            <div class="col-12">
                <div class="form-group mb-0">
                    <label class="input-label">Sinopse</label>
                    <textarea class="custom-input textarea-custom" name="sinopse" placeholder="Escreva sobre o filme..."><%= filme ? filme.sinopse : '' %></textarea>
                </div>
            </div>

            <!-- Status -->
            <div class="col-12">
                <div class="switch-container">
                    <div>
                        <span class="d-block fw-bold text-dark">Status de Publicação</span>
                        <span class="small text-muted" id="statusText"><%= (filme && filme.ativo) ? 'Visível no site' : 'Oculto (Rascunho)' %></span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="ativo" id="ativoSwitch" <%= (!filme || filme.ativo) ? 'checked' : '' %> onchange="toggleStatus()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

        </div>

        <button type="submit" class="btn-save">
            <i class="fas fa-check me-2"></i> <%= filme ? 'Salvar Alterações' : 'Adicionar Filme' %>
        </button>

      </div>

      <!-- COLUNA DIREITA: PREVIEW -->
      <div class="preview-section">
          
          <div class="preview-label">Visualização do Card</div>
          
          <!-- Upload Zone que serve de Preview -->
          <div class="movie-card-clean">
              
              <!-- Pôster / Upload -->
              <div class="mc-poster poster-upload" onclick="document.getElementById('poster').click()">
                  <!-- Imagem Atual -->
                  <% if (filme && filme.poster) { %>
                      <img id="prevImg" class="upload-preview-img" src="/uploads/filmes/<%= filme.poster %>">
                      <div class="upload-overlay">
                          <span class="btn-change"><i class="fas fa-camera"></i> Trocar</span>
                      </div>
                  <% } else { %>
                      <img id="prevImg" class="upload-preview-img" style="display:none;">
                      <div class="upload-content">
                          <i class="fas fa-cloud-upload-alt upload-icon"></i>
                          <div class="text-dark fw-bold">Carregar Pôster</div>
                          <div class="upload-hint">JPG/PNG (Vertical)</div>
                      </div>
                  <% } %>
                  
                  <input type="file" id="poster" name="poster" accept="image/*" style="display:none" onchange="previewFile(this)" <%= filme ? '' : 'required' %>>
              </div>

              <!-- Informações Simuladas -->
              <div class="mc-info">
                  <div class="mc-title" id="prevTitle"><%= filme ? filme.titulo : 'Título do Filme' %></div>
                  <div class="mc-meta">
                      <span class="mc-rating" id="prevRating" style="background:#9CA3AF">L</span>
                      <span id="prevYear"><%= filme && filme.data_lancamento ? new Date(filme.data_lancamento).getFullYear() : '2025' %></span>
                      <span>• Filme</span>
                  </div>
                  <button class="mc-action" type="button">Assistir Trailer</button>
              </div>

          </div>

          <p class="text-muted small mt-4 text-center" style="max-width: 250px;">
              <i class="fas fa-info-circle me-1"></i> Esta é uma prévia de como o filme aparecerá no catálogo para os clientes.
          </p>

      </div>

    </form>
  </div>

</div>

<script>
  // 1. Preview da Imagem no Upload
  function previewFile(input) {
    const file = input.files[0];
    if (file) {
        // Validação simples
        if(file.size > 5 * 1024 * 1024) {
            alert('Imagem muito grande (Max 5MB)');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('prevImg');
            // Esconde o conteúdo de upload e mostra a imagem
            const uploadContent = document.querySelector('.upload-content');
            
            img.src = e.target.result;
            img.style.display = 'block';
            if(uploadContent) uploadContent.style.opacity = '0'; // Esconde texto
            
            // Adiciona overlay se não tiver (caso seja novo upload)
            const parent = document.querySelector('.poster-upload');
            if(!parent.querySelector('.upload-overlay')) {
                const overlay = document.createElement('div');
                overlay.className = 'upload-overlay';
                overlay.innerHTML = '<span class="btn-change"><i class="fas fa-camera"></i> Trocar</span>';
                parent.appendChild(overlay);
            }
        }
        reader.readAsDataURL(file);
    }
  }

  // 2. Atualização em Tempo Real (Preview Card)
  function updatePreview() {
    // Título
    const title = document.getElementById('titulo').value;
    document.getElementById('prevTitle').textContent = title || 'Título do Filme';

    // Ano
    const dateVal = document.getElementById('data').value;
    if(dateVal) {
        document.getElementById('prevYear').textContent = new Date(dateVal).getFullYear();
    }

    // Badge de Classificação (Cores)
    const rating = document.querySelector('input[name="classificacao"]:checked');
    if(rating) {
        const badge = document.getElementById('prevRating');
        badge.textContent = rating.value;
        
        const colors = {
            'L': '#00B050',
            '10': '#0066FF',
            '12': '#FFC107',
            '14': '#FF6600',
            '16': '#FF0000',
            '18': '#000000'
        };
        
        badge.style.background = colors[rating.value] || '#9CA3AF';
        badge.style.color = rating.value === '12' ? 'black' : 'white';
        badge.style.border = rating.value === '18' ? '1px solid black' : 'none';
    }
  }

  // 3. Switch Text
  function toggleStatus() {
    const isChecked = document.getElementById('ativoSwitch').checked;
    const label = document.getElementById('statusText');
    label.textContent = isChecked ? 'Visível no site' : 'Oculto (Rascunho)';
    label.className = isChecked ? 'small text-success fw-bold' : 'small text-muted';
  }

  // Init
  document.addEventListener('DOMContentLoaded', () => {
    updatePreview();
    toggleStatus();
  });
</script>

</body>
</html>