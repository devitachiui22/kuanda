<!DOCTYPE html>
<html lang="pt-AO">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* =========================================
       KUANDA MERCHANT MANAGER CSS
       ========================================= */
    :root {
      --k-red: #E31C25;
      --k-black: #0F0F0F;
      --bg-soft: #F9FAFB;
      --card-radius: 20px;
    }

    body { background-color: var(--bg-soft); }

    /* 1. HEADER */
    .merchant-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 40px; flex-wrap: wrap; gap: 20px;
    }
    .page-title {
      font-weight: 800; color: var(--k-black); margin: 0; font-size: 2rem;
      letter-spacing: -1px; display: flex; align-items: center; gap: 12px;
    }
    .badge-count {
      background: var(--k-black); color: white; font-size: 0.9rem; padding: 5px 12px;
      border-radius: 20px; font-weight: 700;
    }

    .btn-back {
      background: white; border: 1px solid #ddd; color: #555;
      padding: 12px 20px; border-radius: 50px; font-weight: 600;
      transition: 0.3s; text-decoration: none;
    }
    .btn-back:hover { background: #f5f5f5; color: var(--k-black); }

    /* 2. STATS ROW */
    .stats-row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px; margin-bottom: 30px;
    }
    
    .stat-box {
      background: white; border-radius: 16px; padding: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.03);
      display: flex; align-items: center; justify-content: space-between;
    }
    .stat-content h4 { font-size: 1.8rem; font-weight: 800; margin: 0; line-height: 1; }
    .stat-content span { font-size: 0.8rem; font-weight: 600; color: #888; text-transform: uppercase; }
    
    .stat-icon {
      width: 50px; height: 50px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
    }
    
    .st-active .stat-content h4 { color: #10B981; }
    .st-active .stat-icon { background: #E8FDF0; color: #10B981; }
    
    .st-inactive .stat-content h4 { color: #EF4444; }
    .st-inactive .stat-icon { background: #FFEBEE; color: #EF4444; }
    
    .st-prods .stat-content h4 { color: #3B82F6; }
    .st-prods .stat-icon { background: #EBF5FF; color: #3B82F6; }
    
    .st-top .stat-content h4 { color: #F59E0B; }
    .st-top .stat-icon { background: #FFFBEB; color: #F59E0B; }

    /* 3. TABELA PREMIUM */
    .merchant-card {
      background: white; border-radius: var(--card-radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.03);
      overflow: hidden;
    }

    .table-responsive { overflow-x: auto; }
    
    .table-pro { width: 100%; border-collapse: separate; border-spacing: 0; }
    .table-pro th {
      background: #FAFAFA; color: #888; font-size: 0.75rem; font-weight: 800;
      text-transform: uppercase; padding: 20px 25px; text-align: left;
      border-bottom: 1px solid #eee; letter-spacing: 0.5px;
    }
    .table-pro td {
      padding: 20px 25px; border-bottom: 1px solid #f9f9f9; vertical-align: middle;
      color: #444; font-size: 0.95rem; font-weight: 500;
    }
    .table-pro tr:last-child td { border-bottom: none; }
    .table-pro tr:hover td { background: #fafafa; }

    /* Avatar Vendedor */
    .vendor-cell { display: flex; align-items: center; gap: 15px; }
    .v-avatar {
      width: 45px; height: 45px; border-radius: 12px; object-fit: cover;
      background: #eee; border: 1px solid #e5e5e5;
    }
    .v-placeholder {
      width: 45px; height: 45px; border-radius: 12px; background: var(--k-black); color: white;
      display: flex; align-items: center; justify-content: center; font-weight: 700;
    }
    
    .v-info h6 { font-weight: 700; margin: 0; color: var(--k-black); font-size: 0.95rem; }
    .v-info small { font-size: 0.8rem; color: #888; }

    /* Badges */
    .badge-status {
      padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
      display: inline-flex; align-items: center; gap: 6px; text-transform: uppercase;
    }
    .bs-active { background: #E8FDF0; color: #10B981; border: 1px solid #10B981; }
    .bs-inactive { background: #FFEBEE; color: #EF4444; border: 1px solid #EF4444; }
    
    .badge-prod {
      background: #EBF5FF; color: #3B82F6; padding: 5px 10px; border-radius: 8px;
      font-weight: 700; font-size: 0.8rem;
    }

    /* Ações */
    .action-group { display: flex; gap: 8px; }
    
    .btn-act {
      width: 36px; height: 36px; border-radius: 10px; border: none;
      display: flex; align-items: center; justify-content: center;
      transition: 0.2s; cursor: pointer; color: #555; text-decoration: none;
    }
    .btn-view { background: #F3F4F6; color: var(--k-black); }
    .btn-wa { background: #E8FDF0; color: #25D366; }
    .btn-toggle { background: #FFFBEB; color: #F59E0B; }
    
    .btn-act:hover { transform: scale(1.1); filter: brightness(0.95); }

    /* Empty State */
    .empty-merchants {
      text-align: center; padding: 100px 20px;
      background: white; border-radius: var(--card-radius); border: 2px dashed #eee;
    }
    .empty-icon { font-size: 4rem; color: #eee; margin-bottom: 20px; }

    /* Animations */
    .fade-up { animation: fadeUp 0.6s ease forwards; opacity: 0; transform: translateY(20px); }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="container py-4">
  
  <!-- 1. HEADER -->
  <div class="merchant-header fade-up">
    <h2 class="page-title">
        <i class="fas fa-store-alt text-primary"></i> Gerenciar Vendedores
        <span class="badge-count"><%= vendedores.length %></span>
    </h2>
    <a href="/admin" class="btn-back">
      <i class="fas fa-arrow-left"></i> Voltar
    </a>
  </div>

  <% if (vendedores.length === 0) { %>
    <!-- EMPTY STATE -->
    <div class="empty-merchants fade-up" style="animation-delay: 0.1s;">
        <i class="fas fa-store-slash empty-icon"></i>
        <h3 class="fw-bold text-muted">Nenhum Vendedor</h3>
        <p class="text-muted mb-4">Aguardando cadastros na plataforma.</p>
    </div>
  <% } else { %>
    
    <!-- 2. RESUMO RÁPIDO -->
    <div class="stats-row fade-up" style="animation-delay: 0.1s;">
        <div class="stat-box st-active">
            <div class="stat-content">
                <h4><%= vendedores.filter(v => v.loja_ativa).length %></h4>
                <span>Lojas Ativas</span>
            </div>
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        </div>
        
        <div class="stat-box st-inactive">
            <div class="stat-content">
                <h4><%= vendedores.filter(v => !v.loja_ativa).length %></h4>
                <span>Inativas</span>
            </div>
            <div class="stat-icon"><i class="fas fa-ban"></i></div>
        </div>
        
        <div class="stat-box st-prods">
            <div class="stat-content">
                <h4><%= vendedores.reduce((sum, v) => sum + (parseInt(v.total_produtos) || 0), 0) %></h4>
                <span>Produtos Total</span>
            </div>
            <div class="stat-icon"><i class="fas fa-box-open"></i></div>
        </div>
        
        <div class="stat-box st-top">
            <div class="stat-content">
                <h4><%= vendedores.filter(v => v.media_classificacao && v.media_classificacao >= 4).length %></h4>
                <span>Top Sellers</span>
            </div>
            <div class="stat-icon"><i class="fas fa-star"></i></div>
        </div>
    </div>

    <!-- Adicione esta coluna na tabela de vendedores -->
<td>
  <form action="/admin/vendedor/<%= vendedor.id %>/atualizar-limite" method="POST" class="d-inline">
    <div class="input-group input-group-sm">
      <input type="number" 
             name="limite_produtos" 
             value="<%= vendedor.limite_produtos || 10 %>"
             min="1" 
             max="1000"
             class="form-control" 
             style="width: 80px">
      <button type="submit" class="btn btn-sm btn-outline-primary">
        <i class="fas fa-save"></i>
      </button>
    </div>
  </form>
  <small class="d-block text-muted mt-1">
    Usado: <%= vendedor.total_produtos || 0 %>/<%= vendedor.limite_produtos || 10 %>
  </small>
</td>
    <!-- 3. TABELA DE VENDEDORES -->
    <div class="merchant-card fade-up" style="animation-delay: 0.2s;">
      <div class="table-responsive">
        <table class="table-pro">
          <thead>
            <tr>
              <th>Vendedor / Loja</th>
              <th>Contato</th>
              <th>Catálogo</th>
              <th>Reputação</th>
              <th>Status</th>
              <th>Desde</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <% vendedores.forEach(vendedor => { %>
              <tr>
                <!-- Coluna Vendedor -->
                <td>
                  <div class="vendor-cell">
                    <!-- Avatar Logic -->
                    <% 
                    let foto = vendedor.foto_perfil || '';
                    let nome = vendedor.nome || 'Vendedor';
                    %>
                    <% if (foto) { %>
                        <img src="/uploads/perfil/<%= foto %>" class="v-avatar" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=<%= nome.charAt(0) %>&background=0F0F0F&color=fff';">
                    <% } else { %>
                        <div class="v-placeholder"><%= nome.charAt(0).toUpperCase() %></div>
                    <% } %>
                    
                    <div class="v-info">
                        <h6><%= nome %></h6>
                        <small><%= vendedor.nome_loja || 'Loja Sem Nome' %></small>
                        <div class="small text-muted"><%= vendedor.email %></div>
                    </div>
                  </div>
                </td>

                <!-- Contato -->
                <td>
                    <% if (vendedor.telefone) { %>
                        <div class="text-success fw-bold small"><i class="fab fa-whatsapp"></i> <%= vendedor.telefone %></div>
                    <% } else { %>
                        <span class="text-muted small">---</span>
                    <% } %>
                </td>

                <!-- Produtos -->
                <td>
                    <span class="badge-prod"><%= vendedor.total_produtos || 0 %> itens</span>
                </td>

                <!-- Reputação -->
                <td>
                    <% if (vendedor.media_classificacao) { %>
                        <div class="text-warning fw-bold small">
                            <i class="fas fa-star"></i> <%= parseFloat(vendedor.media_classificacao).toFixed(1) %>
                            <span class="text-muted fw-normal">(<%= vendedor.total_avaliacoes %>)</span>
                        </div>
                    <% } else { %>
                        <span class="text-muted small">Novo</span>
                    <% } %>
                </td>

                <!-- Status -->
                <td>
                    <% if (vendedor.loja_ativa) { %>
                        <span class="badge-status bs-active"><i class="fas fa-check"></i> Ativa</span>
                    <% } else { %>
                        <span class="badge-status bs-inactive"><i class="fas fa-times"></i> Inativa</span>
                    <% } %>
                </td>

                <!-- Data -->
                <td>
                    <small class="text-muted fw-bold"><%= new Date(vendedor.created_at).toLocaleDateString('pt-BR') %></small>
                </td>

                <!-- Ações -->
                <td>
                    <div class="action-group">
                        <a href="/loja/<%= vendedor.id %>" target="_blank" class="btn-act btn-view" title="Ver Loja">
                            <i class="fas fa-eye"></i>
                        </a>
                        
                        <form action="/admin/vendedor/<%= vendedor.id %>/toggle-loja" method="POST" class="m-0 toggle-form" 
                              data-active="<%= vendedor.loja_ativa %>">
                            <button type="submit" class="btn-act btn-toggle" title="<%= vendedor.loja_ativa ? 'Desativar' : 'Ativar' %>">
                                <i class="fas fa-power-off"></i>
                            </button>
                        </form>

                        <% if (vendedor.telefone) { %>
                            <a href="https://wa.me/<%= vendedor.telefone.replace(/\D/g, '') %>" target="_blank" class="btn-act btn-wa" title="WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        <% } %>
                    </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  <% } %>

</div>

<script>
  // 1. Confirmação de Toggle Status
  document.querySelectorAll('.toggle-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      const isActive = this.getAttribute('data-active') === 'true' || this.getAttribute('data-active') === '1';
      const action = isActive ? 'desativar' : 'ativar';
      
      if (!confirm(`Tem certeza que deseja ${action} esta loja?`)) {
        e.preventDefault();
      }
    });
  });

  // 2. Toast Helper (Global)
  function showToast(msg, type) {
    const div = document.createElement('div');
    const bg = type === 'success' ? '#10B981' : '#EF4444';
    div.style.cssText = `position:fixed; top:20px; right:20px; z-index:9999; background:${bg}; color:white; padding:12px 25px; border-radius:12px; font-weight:600; box-shadow:0 10px 30px rgba(0,0,0,0.2); animation: slideIn 0.3s ease;`;
    div.innerHTML = `<i class="fas fa-${type==='success'?'check':'exclamation'}-circle me-2"></i> ${msg}`;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
  }

  // Keyframes
  const style = document.createElement('style');
  style.textContent = `@keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} } @keyframes fadeUp { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }`;
  document.head.appendChild(style);
</script>

</body>
</html>