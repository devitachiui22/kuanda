<!DOCTYPE html>
<html lang="pt-AO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Pedido #<%= pedido.codigo || pedido.id %></title>
    
    <!-- Fontes (Raleway + Jakarta) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Raleway:wght@700;800;900&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* =========================================
           SISTEMA DE DESIGN X-PRO (CLIENT VIEW)
           ========================================= */
        :root {
            --bg: #F8F9FD;
            --primary: #0F0F0F;
            --accent: #E31C25; 
            --surface: #FFFFFF;
            --text-main: #1A1A1B;
            --text-dim: #64748B;
            --radius-lg: 24px;
            --radius-md: 16px;
            --shadow-lux: 0 10px 30px -5px rgba(0,0,0,0.04), 0 20px 40px -10px rgba(0,0,0,0.06);
        }

        body {
            background-color: var(--bg);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main);
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6, .brand-font { font-family: 'Raleway', sans-serif; }
        a { text-decoration: none !important; color: inherit; transition: 0.3s; }

        /* HEADER */
        .header-minimal {
            padding: 20px 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
        }
        .brand-logo { font-weight: 900; font-size: 1.4rem; letter-spacing: -1px; color: var(--primary); }
        .brand-logo span { color: var(--accent); }

        .btn-back-pill {
            background: white; padding: 10px 20px; border-radius: 50px;
            font-weight: 700; font-size: 0.85rem; box-shadow: var(--shadow-lux);
            display: flex; align-items: center; gap: 8px; border: 1px solid rgba(0,0,0,0.05);
            color: var(--text-main);
        }
        .btn-back-pill:hover { transform: translateY(-2px); color: var(--accent); }

        /* HERO AREA */
        .order-code { font-weight: 900; font-size: 2rem; letter-spacing: -1.5px; margin-bottom: 5px; color: var(--primary); }
        .badge-status-top {
            font-weight: 800; font-size: 0.8rem; padding: 8px 20px;
            border-radius: 50px; text-transform: uppercase; letter-spacing: 1px;
            display: inline-block;
        }

        /* TIMELINE TRACKER */
        .track-card {
            background: white; border-radius: var(--radius-lg); padding: 30px;
            box-shadow: var(--shadow-lux); margin-bottom: 25px; border: 1px solid rgba(0,0,0,0.02);
        }
        .pro-track { display: flex; justify-content: space-between; position: relative; margin: 20px 0; }
        .pro-track::before {
            content: ''; position: absolute; top: 25px; left: 5%; width: 90%; height: 4px;
            background: #F1F5F9; z-index: 1;
        }
        .track-item { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; width: 25%; }
        .track-icon-box {
            width: 54px; height: 54px; background: white; border: 4px solid #F1F5F9;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-bottom: 12px; transition: 0.4s; color: #cbd5e1;
        }
        .track-item.active .track-icon-box { border-color: #22c55e; background: #ecfdf5; color: #22c55e; transform: scale(1.1); }
        .track-label { font-size: 0.7rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; }
        .track-item.active .track-label { color: #16a34a; }

        /* ITEMS CARD */
        .items-card { background: white; border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-lux); }
        .card-header-lux {
            padding: 20px 25px; background: #FAFBFE; border-bottom: 1px solid #F1F5F9;
            font-weight: 800; font-family: 'Raleway', sans-serif; display: flex; align-items: center; gap: 12px;
        }
        .product-mini-img { width: 60px; height: 60px; object-fit: cover; border-radius: 12px; background: #f1f5f9; border: 1px solid #e2e8f0; }

        /* INFO PANELS (SIDEBAR) */
        .info-panel {
            background: white; border-radius: var(--radius-lg); padding: 24px;
            margin-bottom: 20px; box-shadow: var(--shadow-lux); border: 1px solid rgba(0,0,0,0.02);
        }
        .info-title {
            font-weight: 800; font-size: 0.8rem; color: var(--text-dim);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;
            font-family: 'Raleway', sans-serif;
        }

        .btn-whatsapp-store {
            background: #25D366; color: white; width: 100%; padding: 14px; border-radius: 14px;
            font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2); transition: 0.3s;
        }
        .btn-whatsapp-store:hover { transform: translateY(-2px); background: #20BA5A; color: white; }

        .btn-cancel-order {
            background: #FEF2F2; color: #DC2626; width: 100%; padding: 14px; border: 1px solid #FEE2E2;
            border-radius: 14px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s;
        }
        .btn-cancel-order:hover { background: #fee2e2; color: #b91c1c; }

        /* RESPONSIVE MATRIX */
        @media (max-width: 600px) {
            .table-responsive { display: none; }
            .items-matrix-mobile {
                display: grid !important; grid-template-columns: repeat(3, 1fr) !important;
                gap: 12px; padding: 15px;
            }
            .item-tile {
                display: flex; flex-direction: column; align-items: center; text-align: center;
                background: #F8FAFC; padding: 10px 5px; border-radius: 15px; border: 1px solid #f1f5f9;
            }
            .tile-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 10px; margin-bottom: 8px; }
            .tile-name {
                font-size: 0.65rem; font-weight: 700; margin-bottom: 4px;
                height: 30px; overflow: hidden; display: -webkit-box;
                -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            }
            .tile-price { font-size: 0.7rem; font-weight: 900; color: var(--primary); }
        }
        @media (min-width: 601px) { .items-matrix-mobile { display: none; } }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- HEADER DO COMPRADOR -->
        <header class="header-minimal">
            <div class="brand-logo brand-font">Kuanda<span>Shop</span></div>
            <a href="/meus-pedidos" class="btn-back-pill">
                <i class="fas fa-arrow-left"></i> Meus Pedidos
            </a>
        </header>

        <!-- FEEDBACK MESSAGE -->
        <% if (messages.success) { %>
            <div class="alert alert-success border-0 shadow-sm rounded-4 mb-4 d-flex align-items-center gap-3 p-3 bg-white">
                <i class="fas fa-check-circle text-success fs-4"></i>
                <div class="fw-bold text-dark"><%= messages.success %></div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

        <!-- HERO SECTION -->
        <div class="d-flex flex-wrap justify-content-between align-items-end gap-3 mb-4">
            <div>
                <h1 class="order-code">Pedido #<%= pedido.codigo || pedido.id %></h1>
                <p class="text-muted fw-600 mb-0 d-flex align-items-center gap-2">
                    <i class="far fa-calendar-alt"></i>
                    Feito em: <%= new Date(pedido.created_at).toLocaleString('pt-AO', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                </p>
            </div>
            <div>
                <% 
                    let stColor = '#64748B'; let stBg = '#F1F5F9';
                    if(pedido.status === 'pendente') { stColor = '#D97706'; stBg = '#FFFBEB'; }
                    if(pedido.status === 'confirmado') { stColor = '#2563EB'; stBg = '#EFF6FF'; }
                    if(pedido.status === 'enviado') { stColor = '#7C3AED'; stBg = '#F5F3FF'; }
                    if(pedido.status === 'entregue') { stColor = '#059669'; stBg = '#ECFDF5'; }
                    if(pedido.status === 'cancelado') { stColor = '#DC2626'; stBg = '#FEF2F2'; }
                %>
                <span class="badge-status-top" style="color: <%= stColor %>; background: <%= stBg %>;">
                    <%= pedido.status %>
                </span>
            </div>
        </div>

        <div class="row g-4">
            
            <!-- COLUNA ESQUERDA: RASTREIO E ITENS -->
            <div class="col-lg-8">
                
                <!-- TIMELINE (Visualização de Progresso) -->
                <% if (pedido.status !== 'cancelado') { %>
                    <div class="track-card">
                        <div class="info-title">Acompanhamento</div>
                        <% 
                            let s1 = '', s2 = '', s3 = '', s4 = '';
                            if(['pendente', 'confirmado', 'enviado', 'entregue'].includes(pedido.status)) s1 = 'active';
                            if(['confirmado', 'enviado', 'entregue'].includes(pedido.status)) s2 = 'active';
                            if(['enviado', 'entregue'].includes(pedido.status)) s3 = 'active';
                            if(['entregue'].includes(pedido.status)) s4 = 'active';
                        %>
                        <div class="pro-track">
                            <div class="track-item <%= s1 %>">
                                <div class="track-icon-box"><i class="fas fa-file-alt fs-5"></i></div>
                                <span class="track-label">Enviado</span>
                            </div>
                            <div class="track-item <%= s2 %>">
                                <div class="track-icon-box"><i class="fas fa-box fs-5"></i></div>
                                <span class="track-label">Confirmado</span>
                            </div>
                            <div class="track-item <%= s3 %>">
                                <div class="track-icon-box"><i class="fas fa-truck fs-5"></i></div>
                                <span class="track-label">Em Rota</span>
                            </div>
                            <div class="track-item <%= s4 %>">
                                <div class="track-icon-box"><i class="fas fa-home fs-5"></i></div>
                                <span class="track-label">Entregue</span>
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <div class="track-card bg-danger bg-opacity-10 border border-danger border-opacity-25">
                        <div class="d-flex align-items-center gap-3 text-danger">
                            <i class="fas fa-ban fs-2"></i>
                            <div>
                                <h5 class="fw-800 m-0 brand-font">Pedido Cancelado</h5>
                                <small>Este pedido não será entregue.</small>
                            </div>
                        </div>
                    </div>
                <% } %>

                <!-- LISTA DE PRODUTOS -->
                <div class="items-card">
                    <div class="card-header-lux">
                        <i class="fas fa-shopping-bag text-secondary"></i> Minha Compra
                    </div>

                    <!-- Desktop View -->
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead style="background: #FAFBFE; font-size: 0.75rem; text-transform: uppercase; color: var(--text-dim);">
                                <tr>
                                    <th class="ps-4 py-3 border-0">Item</th>
                                    <th class="text-center border-0">Qtd</th>
                                    <th class="text-end pe-4 border-0">Preço</th>
                                </tr>
                            </thead>
                            <tbody style="border-top: none;">
                                <% itens.forEach(item => { %>
                                    <tr>
                                        <td class="ps-4 py-3 border-bottom-0">
                                            <div class="d-flex align-items-center gap-3">
                                                <!-- Correção: Usando item.imagem1 ou item.produto_imagem -->
                                                <img src="/uploads/produtos/<%= item.imagem1 || item.produto_imagem %>" class="product-mini-img" onerror="this.src='https://via.placeholder.com/60?text=Foto'">
                                                <div>
                                                    <h6 class="mb-0 fw-800 text-dark"><%= item.produto_nome %></h6>
                                                    <small class="text-muted fw-600"><%= parseFloat(item.preco_unitario).toLocaleString() %> Kz</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center fw-800 border-bottom-0">× <%= item.quantidade %></td>
                                        <td class="text-end pe-4 fw-900 border-bottom-0 text-dark">
                                            <%= (item.preco_unitario * item.quantidade).toLocaleString() %> Kz
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Matrix View -->
                    <div class="items-matrix-mobile">
                        <% itens.forEach(item => { %>
                            <div class="item-tile">
                                <img src="/uploads/produtos/<%= item.imagem1 || item.produto_imagem %>" class="tile-img" onerror="this.src='https://via.placeholder.com/60?text=Foto'">
                                <span class="tile-name"><%= item.produto_nome %></span>
                                <span class="tile-price"><%= (item.preco_unitario * item.quantidade).toLocaleString() %> Kz</span>
                            </div>
                        <% }) %>
                    </div>

                    <div class="p-4 bg-light border-top">
                        <div class="d-flex justify-content-between align-items-end">
                            <div>
                                <small class="text-uppercase fw-700 text-muted">Total a Pagar</small>
                                <div class="fw-900 text-dark fs-3 brand-font"><%= parseFloat(pedido.total).toLocaleString() %> Kz</div>
                            </div>
                            <div class="text-end">
                                <small class="text-uppercase fw-700 text-muted">Método</small>
                                <div class="fw-700 text-dark"><i class="far fa-credit-card me-1"></i> <%= pedido.metodo_pagamento %></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUNA DIREITA: INFORMAÇÕES UTEIS -->
            <div class="col-lg-4">
                
                <!-- LOJA / VENDEDOR -->
                <div class="info-panel">
                    <div class="info-title">Vendido Por</div>
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border: 1px solid #e5e7eb;">
                            <i class="fas fa-store fs-5 text-secondary"></i>
                        </div>
                        <div>
                            <!-- Renderizando Nome da Loja ao invés do Cliente -->
                            <h6 class="mb-0 fw-800"><%= pedido.nome_loja || "Loja Parceira" %></h6>
                            <small class="text-success fw-700" style="font-size: 0.7rem;">VERIFICADO <i class="fas fa-check-circle"></i></small>
                        </div>
                    </div>

                    <% if (pedido.vendedor_telefone) { %>
                        <% const msg = `Olá, fiz o pedido #${pedido.codigo || pedido.id} e gostaria de informações...`; %>
                        <a href="https://wa.me/<%= pedido.vendedor_telefone.replace(/\D/g, '') %>?text=<%= encodeURIComponent(msg) %>" target="_blank" class="btn-whatsapp-store">
                            <i class="fab fa-whatsapp fs-5"></i> Falar com a Loja
                        </a>
                    <% } %>
                </div>

                <!-- ENDEREÇO DE ENTREGA -->
                <div class="info-panel">
                    <div class="info-title">Endereço de Entrega</div>
                    <div class="d-flex gap-3">
                        <div style="min-width: 24px;"><i class="fas fa-map-marker-alt fs-5 text-danger"></i></div>
                        <div>
                            <p class="mb-2 fw-700 text-dark" style="font-size: 0.95rem; line-height: 1.5;">
                                <%= pedido.endereco_entrega %>
                            </p>
                            <% if(pedido.ponto_referencia) { %>
                                <small class="text-muted d-block mt-2">
                                    <strong>Ref:</strong> <%= pedido.ponto_referencia %>
                                </small>
                            <% } %>
                        </div>
                    </div>
                </div>

                <!-- AÇÕES DO COMPRADOR -->
                <% if (pedido.status === 'pendente') { %>
                    <div class="info-panel border-danger border-opacity-10">
                        <div class="info-title text-danger">Zona de Perigo</div>
                        <p class="small text-muted mb-3">Você pode cancelar este pedido enquanto ele ainda está pendente.</p>
                        
                        <form action="/pedido/<%= pedido.id %>/cancelar" method="POST" onsubmit="return confirm('Tem certeza que deseja cancelar sua compra?');">
                            <button type="submit" class="btn-cancel-order">
                                <i class="fas fa-times"></i> Cancelar Pedido
                            </button>
                        </form>
                    </div>
                <% } %>

            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>